# Update: single-file index with **code-based access**, **Add Ticket**, and **Student can Update Ticket** via an Edit modal.
# Includes embedded Firebase config from the user, History logging for edits, and Firestore rules.
html = r"""<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AOIT Live Helpdesk — Code Access</title>
  <meta name="description" content="Live Helpdesk with Material Design UI, realtime tickets, history, and code-based access (Student / Teacher-Admin). Students can add and update tickets. This website developed by MR.OZA." />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
    .brand-logo { font-weight: 800; letter-spacing: .5px; }
    #heroCard { transition: transform .2s ease-out; }
    .small { font-size: .9rem; }
    .pill { border-radius: 999px; padding: .25rem .6rem; background: #e0f2f1; }
    #ticketsList .collection-item, #historyList .collection-item {
      display: flex; align-items: center; justify-content: space-between; gap: .75rem;
    }
    .ticket-meta { font-size: .82rem; color: #666; }
    .badge-status { border-radius: 999px; padding: .25rem .5rem; font-size: .75rem; }
    .badge-open { background: #e3f2fd; }
    .badge-in_progress { background: #fff3e0; }
    .badge-resolved { background: #e8f5e9; }
    .action-chip { cursor: pointer; user-select: none; }
    .hide { display: none !important; }
    .footer-note { margin-top: 1rem; }
    .grey-outline { border: 1px dashed #ddd; padding: .75rem; border-radius: .5rem; }
    .mt-8 { margin-top: 2rem; }
    .subtle { color: #607d8b; }
    .credit { font-weight: 800; letter-spacing: .5px; }
  </style>
</head>
<body class="grey lighten-4">
  <nav class="z-depth-1">
    <div class="nav-wrapper teal">
      <a href="#!" class="brand-logo center" id="title3d">AOIT Live Helpdesk</a>
      <ul class="right">
        <li><span class="hide-on-small-only credit" style="margin-right:1rem;">This website developed by MR.OZA</span></li>
        <li><a href="#!" id="btnSignOut" class="tooltipped" data-position="left" data-tooltip="Sign out">
          <i class="material-icons">logout</i></a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="section">
      <div class="card hoverable" id="heroCard">
        <div class="card-content">
          <span class="card-title">
            Welcome to <b>AOIT & Computer Science</b> Helpdesk — Code Access
          </span>
          <p class="grey-text">
            Realtime tickets. Clean Material UI. Admin controls for teachers — no email login, enter with a code.
          </p>
          <div class="mt-8 subtle">
            <span class="pill"><i class="material-icons tiny">person</i> Signed in as: <b id="whoami">—</b></span>
            <span class="pill" style="margin-left:.5rem;"><i class="material-icons tiny">verified_user</i> Role: <b id="role">—</b></span>
          </div>
          <div class="mt-8 credit">This website developed by MR.OZA</div>
        </div>
      </div>
    </div>

    <!-- CODE ACCESS -->
    <div class="row">
      <!-- STUDENT ACCESS -->
      <div class="col s12 m6">
        <div class="card">
          <div class="card-content">
            <span class="card-title">Enter as Student (Code)</span>
            <form id="studentCodeForm" autocomplete="on">
              <div class="input-field">
                <input id="stName" type="text" required>
                <label for="stName">Your Name</label>
              </div>
              <div class="input-field">
                <input id="stCode" type="text" required>
                <label for="stCode">Student Access Code</label>
              </div>
              <button class="btn waves-effect waves-light teal" type="submit">
                Enter <i class="material-icons right">login</i>
              </button>
            </form>
            <p class="grey-text small mt-8">
              Students: get the access code from <b>MR.OZA</b>. You’ll join anonymously and can create and update your own tickets.
            </p>
          </div>
        </div>
      </div>

      <!-- TEACHER / ADMIN ACCESS -->
      <div class="col s12 m6">
        <div class="card">
          <div class="card-content">
            <span class="card-title">Enter as Teacher / Admin (Code)</span>
            <form id="adminCodeForm" autocomplete="on">
              <div class="input-field">
                <input id="adName" type="text" required>
                <label for="adName">Your Name</label>
              </div>
              <div class="input-field">
                <input id="adCode" type="text" required>
                <label for="adCode">Teacher/Admin Access Code</label>
              </div>
              <button class="btn waves-effect waves-light teal" type="submit">
                Enter as Admin <i class="material-icons right">lock_open</i>
              </button>
            </form>
            <p class="grey-text small mt-8">
              Admins can manage students, settings, and any ticket. Share the admin code only with trusted instructors.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- App content -->
    <div id="appArea" class="hide">
      <ul id="tabs" class="tabs">
        <li class="tab col s3"><a class="active" href="#tabTickets">Tickets</a></li>
        <li class="tab col s3"><a href="#tabStudents">Students</a></li>
        <li class="tab col s3"><a href="#tabHistory">History</a></li>
        <li class="tab col s3"><a href="#tabSettings">Settings</a></li>
      </ul>

      <div id="tabTickets" class="col s12">
        <div class="section">
          <div class="card">
            <div class="card-content">
              <span class="card-title">New Ticket</span>
              <form id="ticketForm">
                <div class="input-field">
                  <input id="tTitle" type="text" required>
                  <label for="tTitle">Title</label>
                </div>
                <div class="input-field">
                  <textarea id="tDetail" class="materialize-textarea" required></textarea>
                  <label for="tDetail">Detail</label>
                </div>
                <button class="btn waves-effect waves-light teal" type="submit">
                  Submit <i class="material-icons right">send</i>
                </button>
              </form>
            </div>
          </div>
        </div>
        <div class="section">
          <ul class="collection" id="ticketsList"></ul>
        </div>
      </div>

      <div id="tabStudents" class="col s12">
        <div class="section">
          <div class="card">
            <div class="card-content">
              <span class="card-title">Students</span>
              <p class="grey-text">Admins can disable/enable or remove student profiles.</p>
              <ul class="collection" id="studentsList"></ul>
            </div>
          </div>
        </div>
      </div>

      <div id="tabHistory" class="col s12">
        <div class="section">
          <div class="card">
            <div class="card-content">
              <span class="card-title">Recent Activity</span>
              <p class="grey-text">Live log of ticket events with timestamps.</p>
              <ul class="collection" id="historyList"></ul>
            </div>
          </div>
        </div>
      </div>

      <div id="tabSettings" class="col s12">
        <div class="section">
          <div class="card">
            <div class="card-content">
              <span class="card-title">Class Settings</span>
              <form id="settingsForm">
                <div class="input-field">
                  <input id="cfgTitle" type="text" required>
                  <label for="cfgTitle">Header Title</label>
                </div>
                <div class="input-field">
                  <input id="cfgStudentCode" type="text" required>
                  <label for="cfgStudentCode">Student Access Code</label>
                </div>
                <div class="input-field">
                  <input id="cfgAdminCode" type="text" required>
                  <label for="cfgAdminCode">Teacher/Admin Access Code</label>
                </div>
                <button class="btn waves-effect waves-light teal" type="submit">
                  Save Settings <i class="material-icons right">save</i>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="section center grey-text footer-note">
        <small class="credit">This website developed by MR.OZA</small><br/>
        <small>Welcome to AOIT and all Computer Science classes</small>
      </div>
    </div>

    <!-- Edit Ticket Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <h5>Edit Ticket</h5>
        <div class="input-field">
          <input id="eTitle" type="text" required>
          <label for="eTitle">Title</label>
        </div>
        <div class="input-field">
          <textarea id="eDetail" class="materialize-textarea" required></textarea>
          <label for="eDetail">Detail</label>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-close btn-flat">Cancel</a>
        <a href="#!" id="editSave" class="btn teal">Save changes</a>
      </div>
    </div>

    <!-- Firestore Rules (code-verified roles; NO Storage) -->
    <details class="mt-8">
      <summary><b>Firestore Security Rules (copy/paste)</b></summary>
      <pre><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }

    function hasProfile(uid) {
      return exists(/databases/$(database)/documents/profiles/$(uid));
    }

    function userProfile(uid) {
      return get(/databases/$(database)/documents/profiles/$(uid)).data;
    }

    function isAdmin() {
      return isSignedIn()
             && hasProfile(request.auth.uid)
             && userProfile(request.auth.uid).role == "admin"
             && userProfile(request.auth.uid).disabled != true;
    }

    function isStudent() {
      return isSignedIn()
             && hasProfile(request.auth.uid)
             && userProfile(request.auth.uid).role == "student"
             && userProfile(request.auth.uid).disabled != true;
    }

    function studentCode() {
      return get(/databases/$(database)/documents/config/app).data.studentAccessCode;
    }
    function adminCode() {
      return get(/databases/$(database)/documents/config/app).data.adminAccessCode;
    }

    // Profiles
    match /profiles/{uid} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == uid);

      // Create own profile with correct code (role must match code)
      allow create: if isSignedIn()
                    && request.auth.uid == uid
                    && (
                      (request.resource.data.role == "student" && request.resource.data.entryCode == studentCode())
                      || (request.resource.data.role == "admin" && request.resource.data.entryCode == adminCode())
                    )
                    && request.resource.data.disabled == false;

      // User can edit only displayName; Admin can edit anything
      allow update: if isAdmin()
        || (isSignedIn() && request.auth.uid == uid
            && request.resource.data.displayName is string
            && request.resource.data.role == resource.data.role
            && request.resource.data.entryCode == resource.data.entryCode
            && request.resource.data.disabled == resource.data.disabled
            && request.resource.data.createdAt == resource.data.createdAt);
      allow delete: if isAdmin();
    }

    // Tickets
    match /tickets/{id} {
      allow read: if isSignedIn() && (isAdmin() || resource.data.ownerUid == request.auth.uid);

      // Students can create and update their own (while not resolved); Admins can do all
      allow create: if isSignedIn() && (isAdmin() || isStudent());
      allow update: if isSignedIn() && (
        isAdmin()
        || (request.auth.uid == resource.data.ownerUid && resource.data.status != "resolved")
      );
      allow delete: if isSignedIn() && (
        isAdmin()
        || (request.auth.uid == resource.data.ownerUid && resource.data.status != "resolved")
      );
    }

    // History
    match /history/{hid} {
      allow read: if isSignedIn() && (
        isAdmin()
        || (resource.data.ownerUid == request.auth.uid)
        || (resource.data.actorUid == request.auth.uid)
      );
      allow create: if isSignedIn() && (isAdmin() || isStudent());
      allow update, delete: if false;
    }

    // Config
    match /config/{doc} {
      allow read: if isAdmin(); // Codes hidden from non-admins
      allow write: if isAdmin();
    }
  }
}</code></pre>
      <div class="grey-text small">Create Firestore doc <code>config/app</code> with fields: <code>title</code> (string), <code>studentAccessCode</code> (string), <code>adminAccessCode</code> (string).</div>
    </details>

    <!-- Provided Firebase config (your snippet) -->
    <details class="mt-8">
      <summary><b>Embedded Firebase config (from you)</b></summary>
      <pre><code>// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD4vP74YleiqqpVyIZzCQLqcjWIkcrzlxo",
  authDomain: "mr-oza-helpdesk.firebaseapp.com",
  projectId: "mr-oza-helpdesk",
  storageBucket: "mr-oza-helpdesk.firebasestorage.app",
  messagingSenderId: "340032460471",
  appId: "1:340032460471:web:a0a87895948ca769199f32",
  measurementId: "G-PC18TN83WD"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);</code></pre>
    </details>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script type="module">
    // Firebase SDKs (ES modules via CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged, signOut, signInAnonymously, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      collection, serverTimestamp, onSnapshot, query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // === Initialize Firebase with your config ===
    const firebaseConfig = {
      apiKey: "AIzaSyD4vP74YleiqqpVyIZzCQLqcjWIkcrzlxo",
      authDomain: "mr-oza-helpdesk.firebaseapp.com",
      projectId: "mr-oza-helpdesk",
      storageBucket: "mr-oza-helpdesk.firebasestorage.app",
      messagingSenderId: "340032460471",
      appId: "1:340032460471:web:a0a87895948ca769199f32",
      measurementId: "G-PC18TN83WD"
    };
    const app = initializeApp(firebaseConfig);
    try { isSupported().then(s => { if (s) getAnalytics(app); }); } catch {}

    const auth = getAuth(app);
    const db = getFirestore(app);

    const $$ = (sel) => document.querySelector(sel);
    const toast = (msg) => M.toast({ html: msg, displayLength: 2200 });
    const whoamiEl = $$('#whoami');
    const roleEl   = $$('#role');

    const fmt = (ts) => {
      if (!ts) return '—';
      try { const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }
      catch { return '—'; }
    };
    const safe = (s) => (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    document.addEventListener('DOMContentLoaded', () => {
      M.Tabs.init(document.querySelectorAll('.tabs'));
      M.Tooltip.init(document.querySelectorAll('.tooltipped'));
      M.Modal.init(document.querySelectorAll('.modal'));
      const hero = document.getElementById('heroCard');
      gsap.from('#title3d', {y: -20, opacity: 0, duration: 0.6, ease: 'power2.out'});
      hero.addEventListener('mousemove', (e) => {
        const r = hero.getBoundingClientRect();
        const cx = e.clientX - r.left, cy = e.clientY - r.top;
        const rx = (cy / r.height - 0.5) * -6;
        const ry = (cx / r.width - 0.5) * 6;
        hero.style.transform = `perspective(800px) rotateX(${rx}deg) rotateY(${ry}deg)`;
      });
      hero.addEventListener('mouseleave', () => {
        hero.style.transform = 'perspective(800px) rotateX(0deg) rotateY(0deg)';
      });
    });

    // UI refs
    const studentCodeForm = $$('#studentCodeForm');
    const adminCodeForm   = $$('#adminCodeForm');
    const ticketForm      = $$('#ticketForm');
    const settingsForm    = $$('#settingsForm');
    const btnSignOut      = $$('#btnSignOut');
    const appArea         = $$('#appArea');
    const ticketsList     = $$('#ticketsList');
    const studentsList    = $$('#studentsList');
    const historyList     = $$('#historyList');
    const cfgTitle        = $$('#cfgTitle');
    const cfgStudentCode  = $$('#cfgStudentCode');
    const cfgAdminCode    = $$('#cfgAdminCode');

    // Edit modal refs
    const editModalEl = document.getElementById('editModal');
    const editModal   = () => M.Modal.getInstance(editModalEl);
    const eTitle      = $$('#eTitle');
    const eDetail     = $$('#eDetail');
    const editSave    = $$('#editSave');
    let editDocId     = null;

    let isAdmin = false;
    let profile = null;
    const ticketsCache = new Map(); // id -> ticket data

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (!user) { appArea.classList.add('hide'); whoamiEl.textContent = '—'; roleEl.textContent = '—'; return; }

      whoamiEl.textContent = user.displayName || 'Guest';
      roleEl.textContent = '—';

      const pRef = doc(db, 'profiles', user.uid);
      const snap = await getDoc(pRef);
      if (snap.exists()) {
        profile = snap.data();
        if (profile.disabled) {
          toast('Your account is disabled. Contact the teacher.');
          await signOut(auth); return;
        }
        roleEl.textContent = profile.role === 'admin' ? 'Admin (Teacher)' : 'Student';
      } else {
        profile = null;
        roleEl.textContent = '—';
      }

      // Admin-only read of config title
      try {
        const cfgSnap = await getDoc(doc(db, 'config', 'app'));
        if (cfgSnap.exists()) {
          const data = cfgSnap.data();
          document.getElementById('title3d').textContent = data.title || 'AOIT Live Helpdesk';
        }
      } catch {}

      appArea.classList.remove('hide');
      bindTickets(user);
      bindHistory(user);
      if (profile && profile.role === 'admin') {
        isAdmin = true;
        bindStudents();
        try { await loadSettingsForm(); } catch {}
        cfgTitle.disabled = false; cfgStudentCode.disabled = false; cfgAdminCode.disabled = false;
      } else {
        isAdmin = false;
        studentsList.innerHTML = '<li class="collection-item">Students tab is for admins only.</li>';
        cfgTitle.disabled = true; cfgStudentCode.disabled = true; cfgAdminCode.disabled = true;
      }
    });

    // Join as Student via code
    studentCodeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = (document.getElementById('stName')).value.trim();
      const code = (document.getElementById('stCode')).value.trim();
      try {
        let user = auth.currentUser;
        if (!user) {
          await signInAnonymously(auth);
          user = auth.currentUser;
        }
        try { await updateProfile(user, { displayName: name }); } catch {}
        whoamiEl.textContent = name || user.uid.slice(0,6);

        await setDoc(doc(db, 'profiles', user.uid), {
          displayName: name || 'Student',
          role: 'student',
          entryCode: code,
          disabled: false,
          createdAt: serverTimestamp(),
        });
        toast('Joined as student.');
      } catch (err) { console.error(err); toast(err.message); }
    });

    // Join as Admin via code
    adminCodeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = (document.getElementById('adName')).value.trim();
      const code = (document.getElementById('adCode')).value.trim();
      try {
        let user = auth.currentUser;
        if (!user) {
          await signInAnonymously(auth);
          user = auth.currentUser;
        }
        try { await updateProfile(user, { displayName: name }); } catch {}
        whoamiEl.textContent = name || user.uid.slice(0,6);

        await setDoc(doc(db, 'profiles', user.uid), {
          displayName: name || 'Admin',
          role: 'admin',
          entryCode: code,
          disabled: false,
          createdAt: serverTimestamp(),
        });
        toast('Joined as admin.');
      } catch (err) { console.error(err); toast(err.message); }
    });

    // Sign out
    btnSignOut.addEventListener('click', async () => {
      await signOut(auth);
      toast('Signed out.');
      location.reload();
    });

    // History helper
    async function logHistory(entry) {
      try { await addDoc(collection(db, 'history'), { ...entry, ts: serverTimestamp() }); }
      catch (e) { console.warn('History log failed:', e?.message); }
    }

    // Tickets
    let unsubTickets = null;
    function bindTickets(user) {
      if (unsubTickets) unsubTickets();
      const colRef = collection(db, 'tickets');
      const qRef = (profile && profile.role === 'admin')
        ? query(colRef, orderBy('createdAt', 'desc'))
        : query(colRef, where('ownerUid', '==', user.uid), orderBy('createdAt', 'desc'));

      unsubTickets = onSnapshot(qRef, (snap) => {
        ticketsList.innerHTML = '';
        ticketsCache.clear();
        snap.forEach((docSnap) => {
          const t = docSnap.data();
          ticketsCache.set(docSnap.id, t);
          const li = document.createElement('li');
          li.className = 'collection-item';
          const canEdit = (profile && profile.role === 'admin') || (t.ownerUid === user.uid && (t.status !== 'resolved'));
          li.innerHTML = `
            <div>
              <div><strong>${safe(t.title)}</strong></div>
              <div class="ticket-meta">
                ${safe(t.ownerName ?? 'Unknown')} •
                <span class="badge-status badge-${safe((t.status ?? 'open').replace(' ','_'))}">${safe(t.status ?? 'open')}</span> •
                created: ${fmt(t.createdAt)}${t.updatedAt ? ' • updated: ' + fmt(t.updatedAt) : ''}
              </div>
              <div class="grey-text">${safe(t.detail ?? '')}</div>
            </div>
            <div>
              ${canEdit ? `<a class="btn-flat action-chip" data-act="edit" data-id="${docSnap.id}" title="Edit"><i class="material-icons">edit</i></a>` : ''}
              ${(profile && profile.role === 'admin') || (t.ownerUid === user.uid && t.status !== 'resolved')
                ? `<a class="btn-flat red-text action-chip" data-act="delete" data-id="${docSnap.id}" title="Delete"><i class="material-icons">delete</i></a>`
                : ''}
              ${(profile && profile.role === 'admin')
                ? ['open','in_progress','resolved'].map(st => `<span class="badge-status badge-${st.replace(' ','_')} action-chip" data-act="status" data-id="${docSnap.id}" data-status="${st}" data-cur="${t.status ?? 'open'}">${st}</span>`).join(' ')
                : ''}
            </div>
          `;
          ticketsList.appendChild(li);
          wireTicketButtons(docSnap.id, t);
        });
      });
    }

    function wireTicketButtons(id, t) {
      document.querySelectorAll(`[data-id="${id}"]`).forEach((el) => {
        el.addEventListener('click', async (e) => {
          const target = e.currentTarget;
          const act = target.getAttribute('data-act');
          try {
            if (act === 'delete') {
              const user = auth.currentUser;
              await logHistory({
                type: 'ticket_deleted',
                ticketId: id,
                title: t.title,
                ownerUid: t.ownerUid,
                ownerName: t.ownerName,
                actorUid: user?.uid || null,
                actorName: profile?.displayName || user?.displayName || (user?.uid?.slice(0,6)) || 'User'
              });
              await deleteDoc(doc(db, 'tickets', id));
              toast('Ticket removed.');
            } else if (act === 'status') {
              const from = target.getAttribute('data-cur') || t.status || 'open';
              const to = target.getAttribute('data-status');
              await updateDoc(doc(db, 'tickets', id), { status: to, updatedAt: serverTimestamp() });
              const user = auth.currentUser;
              await logHistory({
                type: 'status_change',
                ticketId: id,
                title: t.title,
                ownerUid: t.ownerUid,
                ownerName: t.ownerName,
                fromStatus: from,
                toStatus: to,
                actorUid: user?.uid || null,
                actorName: profile?.displayName || user?.displayName || (user?.uid?.slice(0,6)) || 'User'
              });
              toast('Status updated.');
            } else if (act === 'edit') {
              // open modal prefilled
              editDocId = id;
              const cur = ticketsCache.get(id) || t;
              eTitle.value = cur.title || '';
              eDetail.value = cur.detail || '';
              M.updateTextFields();
              editModal().open();
            }
          } catch (err) { console.error(err); toast(err.message); }
        });
      });
    }

    // Save edit
    editSave.addEventListener('click', async () => {
      if (!editDocId) return;
      const newTitle = eTitle.value.trim();
      const newDetail = eDetail.value.trim();
      if (!newTitle || !newDetail) return toast('Fill title and detail.');
      try {
        const prev = ticketsCache.get(editDocId) || {};
        await updateDoc(doc(db, 'tickets', editDocId), {
          title: newTitle,
          detail: newDetail,
          updatedAt: serverTimestamp()
        });
        const user = auth.currentUser;
        await logHistory({
          type: 'ticket_updated',
          ticketId: editDocId,
          title: newTitle,
          ownerUid: prev.ownerUid,
          ownerName: prev.ownerName,
          actorUid: user?.uid || null,
          actorName: profile?.displayName || user?.displayName || (user?.uid?.slice(0,6)) || 'User'
        });
        editModal().close();
        toast('Ticket updated.');
        editDocId = null;
      } catch (err) { console.error(err); toast(err.message); }
    });

    // Submit new ticket
    ticketForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return toast('Enter with a code first.');
      const title = (document.getElementById('tTitle')).value.trim();
      const detail = (document.getElementById('tDetail')).value.trim();
      try {
        const docRef = await addDoc(collection(db, 'tickets'), {
          ownerUid: user.uid,
          ownerName: (profile?.displayName) || user.displayName || (user.email?.split('@')[0]) || 'Student',
          title, detail,
          status: 'open',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        });
        await logHistory({
          type: 'ticket_created',
          ticketId: docRef.id,
          title,
          ownerUid: user.uid,
          ownerName: (profile?.displayName) || user.displayName || (user.email?.split('@')[0]) || 'Student',
          actorUid: user.uid,
          actorName: (profile?.displayName) || user.displayName || (user.email?.split('@')[0]) || 'Student'
        });
        (document.getElementById('tTitle')).value = '';
        (document.getElementById('tDetail')).value = '';
        M.updateTextFields();
        toast('Ticket submitted.');
      } catch (err) { console.error(err); toast(err.message); }
    });

    // Students (admin)
    let unsubStudents = null;
    function bindStudents() {
      if (unsubStudents) unsubStudents();
      unsubStudents = onSnapshot(collection(db, 'profiles'), (snap) => {
        studentsList.innerHTML = '';
        snap.forEach((docSnap) => {
          const p = docSnap.data();
          const li = document.createElement('li');
          li.className = 'collection-item';
          li.innerHTML = `
            <div>
              <strong>${safe(p.displayName ?? '(no name)')}</strong>
              <span class="grey-text"> • ${safe(p.role ?? '—')}</span>
            </div>
            <div>
              <a class="btn-flat ${p.disabled ? 'green-text' : 'orange-text'} action-chip" data-act="toggle" data-id="${docSnap.id}">
                ${p.disabled ? 'Enable' : 'Disable'}
              </a>
              <a class="btn-flat red-text action-chip" data-act="remove" data-id="${docSnap.id}" title="Remove">
                <i class="material-icons">delete</i>
              </a>
            </div>
          `;
          studentsList.appendChild(li);
        });

        document.querySelectorAll('#studentsList .action-chip').forEach((el) => {
          el.addEventListener('click', async (e) => {
            const target = e.currentTarget;
            const id = target.getAttribute('data-id');
            const act = target.getAttribute('data-act');
            const ref = doc(db, 'profiles', id);
            if (act === 'toggle') {
              const snap = await getDoc(ref);
              if (snap.exists()) {
                const cur = !!snap.data().disabled;
                await updateDoc(ref, { disabled: !cur });
                toast(cur ? 'Enabled' : 'Disabled');
              }
            } else if (act === 'remove') {
              await deleteDoc(ref);
              toast('Student removed.');
            }
          });
        });
      });
    }

    // History (live)
    let unsubHistory = null;
    function bindHistory(user) {
      if (unsubHistory) unsubHistory();
      const col = collection(db, 'history');
      const qRef = (profile && profile.role === 'admin')
        ? query(col, orderBy('ts', 'desc'), limit(200))
        : query(col, where('ownerUid', '==', user.uid), orderBy('ts', 'desc'), limit(200));
      unsubHistory = onSnapshot(qRef, (snap) => {
        historyList.innerHTML = '';
        snap.forEach((docSnap) => {
          const h = docSnap.data();
          const li = document.createElement('li');
          li.className = 'collection-item';
          let line = '';
          if (h.type === 'ticket_created') {
            line = `<strong>${safe(h.actorName)}</strong> created ticket <em>${safe(h.title)}</em>`;
          } else if (h.type === 'status_change') {
            line = `<strong>${safe(h.actorName)}</strong> changed <em>${safe(h.title)}</em> from <b>${safe(h.fromStatus)}</b> to <b>${safe(h.toStatus)}</b>`;
          } else if (h.type === 'ticket_updated') {
            line = `<strong>${safe(h.actorName)}</strong> updated <em>${safe(h.title)}</em>`;
          } else if (h.type === 'ticket_deleted') {
            line = `<strong>${safe(h.actorName)}</strong> deleted ticket <em>${safe(h.title)}</em>`;
          } else {
            line = `${safe(h.type)} — ${safe(h.title || '')}`;
          }
          li.innerHTML = `
            <div>
              <div>${line}</div>
              <div class="ticket-meta">Owner: ${safe(h.ownerName ?? 'Unknown')} • ${fmt(h.ts)}</div>
            </div>
          `;
          historyList.appendChild(li);
        });
      });
    }

    // Settings (admin)
    async function loadSettingsForm() {
      const ref = doc(db, 'config', 'app');
      const snap = await getDoc(ref);
      const data = snap.exists() ? snap.data() : { title: 'AOIT Live Helpdesk', studentAccessCode: '', adminAccessCode: '' };
      cfgTitle.value = data.title || '';
      cfgStudentCode.value = data.studentAccessCode || '';
      cfgAdminCode.value = data.adminAccessCode || '';
      M.updateTextFields();
    }
    settingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!(profile && profile.role === 'admin')) return;
      try {
        await setDoc(doc(db, 'config', 'app'), {
          title: cfgTitle.value.trim(),
          studentAccessCode: cfgStudentCode.value.trim(),
          adminAccessCode: cfgAdminCode.value.trim()
        }, { merge: true });
        document.getElementById('title3d').textContent = cfgTitle.value.trim() || 'AOIT Live Helpdesk';
        toast('Settings saved.');
      } catch (err) { console.error(err); toast(err.message); }
    });
  </script>

  <!-- No Firebase Storage used. Anonymous Auth + Firestore Rules validate codes securely. -->
</body>
</html>
"""
path = "/mnt/data/index-code-access-helpdesk-edit.html"
with open(path, "w") as f:
    f.write(html)
path
