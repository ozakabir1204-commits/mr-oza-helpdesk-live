# Create updated single-file HTML with a visible credit: "This website developed by MR.OZA"
html = r"""<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AOIT Live Helpdesk — Mr Oza</title>
  <meta name="description" content="Live Helpdesk with Material Design UI, 3D animation, realtime tickets, history, and role-select login (Teacher/Student). Admin controls for Mr Oza. This website developed by MR.OZA." />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
    .brand-logo { font-weight: 800; letter-spacing: .5px; }
    #heroCard { transition: transform .2s ease-out; }
    .small { font-size: .9rem; }
    .pill { border-radius: 999px; padding: .25rem .6rem; background: #e0f2f1; }
    #ticketsList .collection-item, #historyList .collection-item {
      display: flex; align-items: center; justify-content: space-between; gap: .75rem;
    }
    .ticket-meta { font-size: .82rem; color: #666; }
    .badge-status { border-radius: 999px; padding: .25rem .5rem; font-size: .75rem; }
    .badge-open { background: #e3f2fd; }
    .badge-in_progress { background: #fff3e0; }
    .badge-resolved { background: #e8f5e9; }
    .action-chip { cursor: pointer; user-select: none; }
    .hide { display: none !important; }
    .footer-note { margin-top: 1rem; }
    .grey-outline { border: 1px dashed #ddd; padding: .75rem; border-radius: .5rem; }
    .mt-8 { margin-top: 2rem; }
    .subtle { color: #607d8b; }
    .credit { font-weight: 800; letter-spacing: .5px; }
  </style>
</head>
<body class="grey lighten-4">
  <nav class="z-depth-1">
    <div class="nav-wrapper teal">
      <a href="#!" class="brand-logo center" id="title3d">AOIT Live Helpdesk</a>
      <ul class="right">
        <li><span class="hide-on-small-only credit" style="margin-right:1rem;">This website developed by MR.OZA</span></li>
        <li><a href="#!" id="btnSignOut" class="tooltipped" data-position="left" data-tooltip="Sign out">
          <i class="material-icons">logout</i></a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="section">
      <div class="card hoverable" id="heroCard">
        <div class="card-content">
          <span class="card-title">
            Welcome to <b>AOIT & Computer Science</b> Helpdesk — <b>Mr Oza</b>
          </span>
          <p class="grey-text">
            Realtime tickets. Clean Material UI. Admin controls for teachers.
          </p>
          <div class="mt-8 subtle">
            <span class="pill"><i class="material-icons tiny">person</i> Signed in as: <b id="whoami">—</b></span>
            <span class="pill" style="margin-left:.5rem;"><i class="material-icons tiny">verified_user</i> Role: <b id="role">—</b></span>
          </div>
          <div class="mt-8 credit">This website developed by MR.OZA</div>
        </div>
      </div>
    </div>

    <!-- Role-select Login + Student Sign Up -->
    <div class="row">
      <div class="col s12 m6">
        <div class="card">
          <div class="card-content">
            <span class="card-title">Login</span>
            <form id="roleLoginForm" autocomplete="on">
              <div class="input-field">
                <select id="roleSelect" required>
                  <option value="student" selected>Student</option>
                  <option value="teacher">Teacher</option>
                </select>
                <label for="roleSelect">I am</label>
              </div>
              <div class="input-field">
                <input id="email" type="email" required>
                <label for="email">Email</label>
              </div>
              <div class="input-field">
                <input id="password" type="password" required>
                <label for="password">Password</label>
              </div>
              <button class="btn waves-effect waves-light teal" type="submit">
                Sign In <i class="material-icons right">login</i>
              </button>
            </form>
            <p class="grey-text small mt-8">
              Choose <b>Teacher</b> if you’re Mr Oza or another instructor. Teacher accounts must be granted <code>admin: true</code> via a one-time Node script.
            </p>
          </div>
        </div>
      </div>

      <div class="col s12 m6">
        <div class="card">
          <div class="card-content">
            <span class="card-title">Student Sign Up</span>
            <form id="signUpForm" autocomplete="on">
              <div class="input-field">
                <input id="upName" type="text" required>
                <label for="upName">Full Name</label>
              </div>
              <div class="input-field">
                <input id="upEmail" type="email" required>
                <label for="upEmail">Email</label>
              </div>
              <div class="input-field">
                <input id="upPassword" type="password" minlength="6" required>
                <label for="upPassword">Password (6+ chars)</label>
              </div>
              <div class="input-field">
                <input id="joinCode" type="text" required>
                <label for="joinCode">Class Join Code</label>
              </div>
              <button class="btn waves-effect waves-light teal" type="submit">
                Create Account <i class="material-icons right">person_add</i>
              </button>
            </form>
            <p class="grey-text small grey-outline mt-8">
              Students: get the join code from <b>Mr Oza</b>. It’s required to create your account.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- App content -->
    <div id="appArea" class="hide">
      <ul id="tabs" class="tabs">
        <li class="tab col s3"><a class="active" href="#tabTickets">Tickets</a></li>
        <li class="tab col s3"><a href="#tabStudents">Students</a></li>
        <li class="tab col s3"><a href="#tabHistory">History</a></li>
        <li class="tab col s3"><a href="#tabSettings">Settings</a></li>
      </ul>

      <div id="tabTickets" class="col s12">
        <div class="section">
          <div class="card">
            <div class="card-content">
              <span class="card-title">New Ticket</span>
              <form id="ticketForm">
                <div class="input-field">
                  <input id="tTitle" type="text" required>
                  <label for="tTitle">Title</label>
                </div>
                <div class="input-field">
                  <textarea id="tDetail" class="materialize-textarea" required></textarea>
                  <label for="tDetail">Detail</label>
                </div>
                <button class="btn waves-effect waves-light teal" type="submit">
                  Submit <i class="material-icons right">send</i>
                </button>
              </form>
            </div>
          </div>
        </div>
        <div class="section">
          <ul class="collection" id="ticketsList"></ul>
        </div>
      </div>

      <div id="tabStudents" class="col s12">
        <div class="section">
          <div class="card">
            <div class="card-content">
              <span class="card-title">Students</span>
              <p class="grey-text">Admins can disable/enable or remove student profiles.</p>
              <ul class="collection" id="studentsList"></ul>
            </div>
          </div>
        </div>
      </div>

      <div id="tabHistory" class="col s12">
        <div class="section">
          <div class="card">
            <div class="card-content">
              <span class="card-title">Recent Activity</span>
              <p class="grey-text">Live log of ticket events with timestamps.</p>
              <ul class="collection" id="historyList"></ul>
            </div>
          </div>
        </div>
      </div>

      <div id="tabSettings" class="col s12">
        <div class="section">
          <div class="card">
            <div class="card-content">
              <span class="card-title">Class Settings</span>
              <form id="settingsForm">
                <div class="input-field">
                  <input id="cfgTitle" type="text" required>
                  <label for="cfgTitle">Header Title</label>
                </div>
                <div class="input-field">
                  <input id="cfgJoinCode" type="text" required>
                  <label for="cfgJoinCode">Class Join Code</label>
                </div>
                <button class="btn waves-effect waves-light teal" type="submit">
                  Save Settings <i class="material-icons right">save</i>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="section center grey-text footer-note">
        <small class="credit">This website developed by MR.OZA</small><br/>
        <small>Welcome to AOIT and all Computer Science classes • Created by <b>Mr Oza</b></small>
      </div>
    </div>

    <details class="mt-8">
      <summary><b>Firestore Security Rules (copy/paste)</b></summary>
      <pre><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isAdmin()    { return isSignedIn() && request.auth.token.admin == true; }
    function classJoinCode() {
      return get(/databases/$(database)/documents/config/app).data.classJoinCode;
    }

    match /profiles/{uid} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == uid);
      allow create: if isSignedIn()
                    && request.auth.uid == uid
                    && request.resource.data.role == "student"
                    && request.resource.data.classCode == classJoinCode()
                    && !("admin" in request.resource.data);
      allow update: if isAdmin()
        || (isSignedIn() && request.auth.uid == uid
            && request.resource.data.displayName is string
            && request.resource.data.role == resource.data.role
            && request.resource.data.classCode == resource.data.classCode
            && request.resource.data.disabled == resource.data.disabled
            && request.resource.data.createdAt == resource.data.createdAt);
      allow delete: if isAdmin();
    }

    match /tickets/{id} {
      allow read: if isSignedIn() && (isAdmin() || resource.data.ownerUid == request.auth.uid);
      allow create: if isSignedIn() && (
        isAdmin()
        || (exists(/databases/$(database)/documents/profiles/$(request.auth.uid))
            && get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.disabled != true)
      );
      allow update: if isSignedIn() && (
        isAdmin()
        || (request.auth.uid == resource.data.ownerUid && resource.data.status != "resolved")
      );
      allow delete: if isSignedIn() && (
        isAdmin()
        || (request.auth.uid == resource.data.ownerUid && resource.data.status != "resolved")
      );
    }

    match /history/{hid} {
      allow read: if isSignedIn() && (
        isAdmin()
        || (resource.data.ownerUid == request.auth.uid)
        || (resource.data.actorUid == request.auth.uid)
      );
      allow create: if isSignedIn() && (
        isAdmin()
        || (request.resource.data.actorUid == request.auth.uid)
      );
      allow update, delete: if false;
    }

    match /config/{doc} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}</code></pre>
    </details>

    <details class="mt-8">
      <summary><b>Admin claim script (run once locally)</b></summary>
      <pre><code>// setAdminClaim.js (Node)
const admin = require('firebase-admin');
const sa = require('./serviceAccountKey.json');
admin.initializeApp({ credential: admin.credential.cert(sa) });
(async () => {
  const email = process.argv[2];
  if (!email) { console.error('Usage: node setAdminClaim.js "teacher@example.com"'); process.exit(1); }
  const user = await admin.auth().getUserByEmail(email);
  await admin.auth().setCustomUserClaims(user.uid, { admin: true });
  console.log('Admin set for', email, 'UID:', user.uid, '\\nSign out/in to refresh token.');
})();</code></pre>
    </details>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      collection, serverTimestamp, onSnapshot, query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // === Embedded Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyD4vP74YleiqqpVyIZzCQLqcjWIkcrzlxo",
      authDomain: "mr-oza-helpdesk.firebaseapp.com",
      projectId: "mr-oza-helpdesk",
      storageBucket: "mr-oza-helpdesk.firebasestorage.app",
      messagingSenderId: "340032460471",
      appId: "1:340032460471:web:a0a87895948ca769199f32",
      measurementId: "G-PC18TN83WD"
    };
    // =================================

    const app = initializeApp(firebaseConfig);
    try { isSupported().then(s => { if (s) getAnalytics(app); }); } catch {}

    const auth = getAuth(app);
    const db = getFirestore(app);

    const $$ = (sel) => document.querySelector(sel);
    const toast = (msg) => M.toast({ html: msg, displayLength: 2200 });
    const whoamiEl = $$('#whoami');
    const roleEl   = $$('#role');

    const fmt = (ts) => {
      if (!ts) return '—';
      try { const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }
      catch { return '—'; }
    };
    const safe = (s) => (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    document.addEventListener('DOMContentLoaded', () => {
      M.Tabs.init(document.querySelectorAll('.tabs'));
      M.FormSelect.init(document.querySelectorAll('select'));
      M.Tooltip.init(document.querySelectorAll('.tooltipped'));
      const hero = document.getElementById('heroCard');
      gsap.from('#title3d', {y: -20, opacity: 0, duration: 0.6, ease: 'power2.out'});
      hero.addEventListener('mousemove', (e) => {
        const r = hero.getBoundingClientRect();
        const cx = e.clientX - r.left, cy = e.clientY - r.top;
        const rx = (cy / r.height - 0.5) * -6;
        const ry = (cx / r.width - 0.5) * 6;
        hero.style.transform = `perspective(800px) rotateX(${rx}deg) rotateY(${ry}deg)`;
      });
      hero.addEventListener('mouseleave', () => {
        hero.style.transform = 'perspective(800px) rotateX(0deg) rotateY(0deg)';
      });
    });

    // UI refs
    const roleLoginForm = $$('#roleLoginForm');
    const signUpForm = $$('#signUpForm');
    const ticketForm = $$('#ticketForm');
    const settingsForm = $$('#settingsForm');
    const btnSignOut = $$('#btnSignOut');
    const appArea = $$('#appArea');
    const ticketsList = $$('#ticketsList');
    const studentsList = $$('#studentsList');
    const historyList = $$('#historyList');
    const cfgTitle = $$('#cfgTitle');
    const cfgJoinCode = $$('#cfgJoinCode');

    let isAdmin = false;
    let profile = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) { appArea.classList.add('hide'); whoamiEl.textContent = '—'; roleEl.textContent = '—'; return; }

      await user.getIdToken(true);
      const token = await user.getIdTokenResult();
      isAdmin = !!token.claims.admin;

      whoamiEl.textContent = user.displayName ? user.displayName : (user.email ? user.email.split('@')[0] : 'User');
      roleEl.textContent = isAdmin ? 'Admin (Teacher)' : 'Student';

      if (isAdmin) {
        profile = null;
      } else {
        const pRef = doc(db, 'profiles', user.uid);
        const snap = await getDoc(pRef);
        if (snap.exists()) {
          profile = snap.data();
          if (profile.disabled) {
            toast('Your account is disabled. Contact your teacher.');
            await signOut(auth);
            return;
          }
        } else {
          toast('Complete sign-up with a valid Join Code first.');
          await signOut(auth);
          return;
        }
      }

      const cfgRef = doc(db, 'config', 'app');
      const cfgSnap = await getDoc(cfgRef);
      if (cfgSnap.exists()) {
        const data = cfgSnap.data();
        document.getElementById('title3d').textContent = data.title || 'AOIT Live Helpdesk';
      }

      appArea.classList.remove('hide');
      bindTickets(user);
      bindHistory(user);
      if (isAdmin) {
        bindStudents();
        loadSettingsForm();
        cfgTitle.disabled = false; cfgJoinCode.disabled = false;
      } else {
        studentsList.innerHTML = '<li class="collection-item">Students tab is for admins only.</li>';
        cfgTitle.disabled = true; cfgJoinCode.disabled = true;
      }
    });

    // Role-select login
    roleLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const roleChoice = (document.getElementById('roleSelect')).value;
      const email = (document.getElementById('email')).value.trim();
      const pass  = (document.getElementById('password')).value;
      try {
        const { user } = await signInWithEmailAndPassword(auth, email, pass);
        await user.getIdToken(true);
        const token = await user.getIdTokenResult();
        const claimAdmin = !!token.claims.admin;
        if (roleChoice === 'teacher' && !claimAdmin) {
          await signOut(auth);
          toast('This account is not an admin. Ask Mr Oza to grant admin via the Node script.');
          return;
        }
        if (roleChoice === 'student' && claimAdmin) {
          toast('Admin account detected — continuing with admin features.');
        } else {
          toast('Signed in.');
        }
      } catch (err) { console.error(err); toast(err.message); }
    });

    // Student Sign Up
    signUpForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = (document.getElementById('upName')).value.trim();
      const email = (document.getElementById('upEmail')).value.trim();
      const pass  = (document.getElementById('upPassword')).value;
      const code  = (document.getElementById('joinCode')).value.trim();
      try {
        const { user } = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(user, { displayName: name });
        await setDoc(doc(db, 'profiles', user.uid), {
          displayName: name,
          role: 'student',
          classCode: code,
          disabled: false,
          createdAt: serverTimestamp(),
        });
        toast('Account created. Sign in now.');
        await signOut(auth);
      } catch (err) { console.error(err); toast(err.message); }
    });

    // Global Sign Out
    btnSignOut.addEventListener('click', async () => {
      await signOut(auth);
      toast('Signed out.');
      location.reload();
    });

    // History logger
    async function logHistory(entry) {
      try { await addDoc(collection(db, 'history'), { ...entry, ts: serverTimestamp() }); }
      catch (e) { console.warn('History log failed:', e?.message); }
    }

    // Tickets
    let unsubTickets = null;
    function bindTickets(user) {
      if (unsubTickets) unsubTickets();
      const colRef = collection(db, 'tickets');
      const qRef = isAdmin
        ? query(colRef, orderBy('createdAt', 'desc'))
        : query(colRef, where('ownerUid', '==', user.uid), orderBy('createdAt', 'desc'));
      unsubTickets = onSnapshot(qRef, (snap) => {
        ticketsList.innerHTML = '';
        snap.forEach((docSnap) => {
          const t = docSnap.data();
          const li = document.createElement('li');
          li.className = 'collection-item';
          li.innerHTML = `
            <div>
              <div><strong>${safe(t.title)}</strong></div>
              <div class="ticket-meta">
                ${safe(t.ownerName ?? 'Unknown')} •
                <span class="badge-status badge-${safe((t.status ?? 'open').replace(' ','_'))}">${safe(t.status ?? 'open')}</span> •
                created: ${fmt(t.createdAt)}${t.updatedAt ? ' • updated: ' + fmt(t.updatedAt) : ''}
              </div>
              <div class="grey-text">${safe(t.detail ?? '')}</div>
            </div>
            <div>${renderTicketActions(docSnap.id, t)}</div>
          `;
          ticketsList.appendChild(li);
          wireTicketButtons(docSnap.id, t);
        });
      });
    }

    function renderTicketActions(id, t) {
      const actions = [];
      if (isAdmin) {
        ['open','in_progress','resolved'].forEach(st => {
          actions.push(`<span class="badge-status badge-${st.replace(' ','_')} action-chip" data-act="status" data-id="${id}" data-status="${st}" data-cur="${t.status ?? 'open'}">${st}</span>`);
        });
        actions.push(`<a class="btn-flat red-text action-chip" data-act="delete" data-id="${id}" title="Delete"><i class="material-icons">delete</i></a>`);
      } else {
        if (t.status !== 'resolved') {
          actions.push(`<a class="btn-flat red-text action-chip" data-act="delete" data-id="${id}" title="Delete"><i class="material-icons">delete</i></a>`);
        }
      }
      return actions.join(' ');
    }

    function wireTicketButtons(id, t) {
      document.querySelectorAll(`[data-id="${id}"]`).forEach((el) => {
        el.addEventListener('click', async (e) => {
          const target = e.currentTarget;
          const act = target.getAttribute('data-act');
          try {
            if (act === 'delete') {
              const user = auth.currentUser;
              await logHistory({
                type: 'ticket_deleted',
                ticketId: id,
                title: t.title,
                ownerUid: t.ownerUid,
                ownerName: t.ownerName,
                actorUid: user?.uid || null,
                actorName: user?.displayName || (user?.email?.split('@')[0]) || 'User'
              });
              await deleteDoc(doc(db, 'tickets', id));
              toast('Ticket removed.');
            } else if (act === 'status') {
              const from = target.getAttribute('data-cur') || t.status || 'open';
              const to = target.getAttribute('data-status');
              await updateDoc(doc(db, 'tickets', id), { status: to, updatedAt: serverTimestamp() });
              const user = auth.currentUser;
              await logHistory({
                type: 'status_change',
                ticketId: id,
                title: t.title,
                ownerUid: t.ownerUid,
                ownerName: t.ownerName,
                fromStatus: from,
                toStatus: to,
                actorUid: user?.uid || null,
                actorName: user?.displayName || (user?.email?.split('@')[0]) || 'User'
              });
              toast('Status updated.');
            }
          } catch (err) { console.error(err); toast(err.message); }
        });
      });
    }

    ticketForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return toast('Please sign in.');
      const title = (document.getElementById('tTitle')).value.trim();
      const detail = (document.getElementById('tDetail')).value.trim();
      try {
        const docRef = await addDoc(collection(db, 'tickets'), {
          ownerUid: user.uid,
          ownerName: user.displayName || (user.email?.split('@')[0]) || 'Student',
          title, detail,
          status: 'open',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        });
        await logHistory({
          type: 'ticket_created',
          ticketId: docRef.id,
          title,
          ownerUid: user.uid,
          ownerName: user.displayName || (user.email?.split('@')[0]) || 'Student',
          actorUid: user.uid,
          actorName: user.displayName || (user.email?.split('@')[0]) || 'Student'
        });
        (document.getElementById('tTitle')).value = '';
        (document.getElementById('tDetail')).value = '';
        M.updateTextFields();
        toast('Ticket submitted.');
      } catch (err) { console.error(err); toast(err.message); }
    });

    // Students (admin)
    let unsubStudents = null;
    function bindStudents() {
      if (unsubStudents) unsubStudents();
      unsubStudents = onSnapshot(collection(db, 'profiles'), (snap) => {
        studentsList.innerHTML = '';
        snap.forEach((docSnap) => {
          const p = docSnap.data();
          const li = document.createElement('li');
          li.className = 'collection-item';
          li.innerHTML = `
            <div>
              <strong>${safe(p.displayName ?? '(no name)')}</strong>
              <span class="grey-text"> • ${safe(p.role ?? '—')}</span>
            </div>
            <div>
              <a class="btn-flat ${p.disabled ? 'green-text' : 'orange-text'} action-chip" data-act="toggle" data-id="${docSnap.id}">
                ${p.disabled ? 'Enable' : 'Disable'}
              </a>
              <a class="btn-flat red-text action-chip" data-act="remove" data-id="${docSnap.id}" title="Remove">
                <i class="material-icons">delete</i>
              </a>
            </div>
          `;
          studentsList.appendChild(li);
        });

        document.querySelectorAll('#studentsList .action-chip').forEach((el) => {
          el.addEventListener('click', async (e) => {
            const target = e.currentTarget;
            const id = target.getAttribute('data-id');
            const act = target.getAttribute('data-act');
            const ref = doc(db, 'profiles', id);
            if (act === 'toggle') {
              const snap = await getDoc(ref);
              if (snap.exists()) {
                const cur = !!snap.data().disabled;
                await updateDoc(ref, { disabled: !cur });
                toast(cur ? 'Enabled' : 'Disabled');
              }
            } else if (act === 'remove') {
              await deleteDoc(ref);
              toast('Student removed.');
            }
          });
        });
      });
    }

    // History (live)
    let unsubHistory = null;
    function bindHistory(user) {
      if (unsubHistory) unsubHistory();
      const col = collection(db, 'history');
      const qRef = isAdmin
        ? query(col, orderBy('ts', 'desc'), limit(200))
        : query(col, where('ownerUid', '==', user.uid), orderBy('ts', 'desc'), limit(200));
      unsubHistory = onSnapshot(qRef, (snap) => {
        historyList.innerHTML = '';
        snap.forEach((docSnap) => {
          const h = docSnap.data();
          const li = document.createElement('li');
          li.className = 'collection-item';
          let line = '';
          if (h.type === 'ticket_created') {
            line = `<strong>${safe(h.actorName)}</strong> created ticket <em>${safe(h.title)}</em>`;
          } else if (h.type === 'status_change') {
            line = `<strong>${safe(h.actorName)}</strong> changed <em>${safe(h.title)}</em> from <b>${safe(h.fromStatus)}</b> to <b>${safe(h.toStatus)}</b>`;
          } else if (h.type === 'ticket_deleted') {
            line = `<strong>${safe(h.actorName)}</strong> deleted ticket <em>${safe(h.title)}</em>`;
          } else {
            line = `${safe(h.type)} — ${safe(h.title || '')}`;
          }
          li.innerHTML = `
            <div>
              <div>${line}</div>
              <div class="ticket-meta">Owner: ${safe(h.ownerName ?? 'Unknown')} • ${fmt(h.ts)}</div>
            </div>
          `;
          historyList.appendChild(li);
        });
      });
    }

    // Settings
    async function loadSettingsForm() {
      const ref = doc(db, 'config', 'app');
      const snap = await getDoc(ref);
      const data = snap.exists() ? snap.data() : { title: 'AOIT Live Helpdesk', classJoinCode: '' };
      cfgTitle.value = data.title || '';
      cfgJoinCode.value = data.classJoinCode || '';
      M.updateTextFields();
    }
    settingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await setDoc(doc(db, 'config', 'app'), {
          title: cfgTitle.value.trim(),
          classJoinCode: cfgJoinCode.value.trim()
        }, { merge: true });
        document.getElementById('title3d').textContent = cfgTitle.value.trim() || 'AOIT Live Helpdesk';
        toast('Settings saved.');
      } catch (err) { console.error(err); toast(err.message); }
    });
  </script>

  <!-- No Firebase Storage used in the app. -->
</body>
</html>
"""
path = "/mnt/data/index-role-select-helpdesk-oza-credit.html"
with open(path, "w") as f:
    f.write(html)
path
