<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MR Oza â€¢ Live Helpâ€‘Desk (AOIT & CS Classes)</title>
  <meta name="description" content="Realâ€‘time Live Helpâ€‘Desk for AOIT & Computer Science classes. Chat history, tickets (add/update/close), and admin tools for MR Oza. Built with Firebase + Material UI." />

  <!-- Roboto + Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

  <style>
    :root {
      --bg: #0b1020;
      --card: #121a2f;
      --card-2: #0f1630;
      --text: #e9eefc;
      --muted: #b8c2e6;
      --primary: #4f8cff; /* material-ish blue */
      --accent: #30d0a0;  /* teal */
      --warning: #ffb020;
      --danger: #ff5d5d;
      --success: #2cc071;
      --chip: #1a2442;
      --ripple: rgba(255,255,255,0.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Roboto, system-ui, -apple-system, Segoe UI, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background: radial-gradient(1200px 600px at 10% -10%, #233058 0, rgba(0,0,0,0) 60%),
                             radial-gradient(1200px 600px at 100% 0%, #1d2446 0, rgba(0,0,0,0) 60%),
                             linear-gradient(180deg, #0a0f1f, #0b1020 40%);
      overflow: hidden;
    }

    /* Top app bar */
    .appbar {
      display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem; position:sticky; top:0; z-index:10;
      background: linear-gradient(90deg, rgba(15,22,48,.8), rgba(18,26,47,.8));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .logo {
      width:40px; height:40px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg, #4f8cff, #30d0a0);
      box-shadow: 0 6px 24px rgba(79,140,255,.4);
      font-weight:900; letter-spacing:.5px;
    }
    .title {
      font-size:clamp(16px, 2.2vw, 22px); font-weight:800; letter-spacing:.3px; line-height:1.1;
    }
    .subtitle {
      font-size:12px; color: var(--muted);
    }
    .spacer { flex: 1; }
    .btn {
      appearance:none; border:0; outline:0; cursor:pointer; border-radius:14px;
      padding:.6rem .9rem; font-weight:600; color:#0b1020; background: var(--text);
      transition: transform .05s ease-in-out, filter .2s ease;
      position:relative; overflow:hidden;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px) scale(.98); }
    .btn.primary { background: linear-gradient(135deg, #4f8cff, #5eb1f7); color:white; }
    .btn.ghost { background: transparent; color: var(--text); border:1px solid rgba(255,255,255,.15); }
    .icon { font-family: 'Material Symbols Rounded'; font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }

    /* Layout */
    .shell { display:grid; grid-template-rows: auto 1fr; height: 100%; }
    .main { display:grid; grid-template-columns: 300px 1fr; gap: 14px; padding: 14px; height: calc(100vh - 72px); }
    @media (max-width: 900px){ .main { grid-template-columns: 1fr; height: auto; overflow:auto; } }

    .card { background: linear-gradient(180deg, var(--card), var(--card-2)); border: 1px solid rgba(255,255,255,.06); border-radius: 22px;
            box-shadow: 0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04); }

    /* Left panel: welcome + auth + tabs */
    .left { padding: 16px; display:flex; flex-direction:column; gap:16px; }
    .hero {
      position:relative; overflow:hidden; padding:16px; border-radius:18px; background: linear-gradient(135deg, rgba(79,140,255,.2), rgba(48,208,160,.15));
      border: 1px solid rgba(255,255,255,.08);
    }
    .hero h1 { margin:0; font-size: clamp(18px, 2.6vw, 22px); }
    .ticker { color: var(--muted); font-size: 12px; margin-top: 6px; white-space: nowrap; overflow: hidden; }
    .ticker span { display:inline-block; padding-right: 40px; animation: marquee 16s linear infinite; }
    @keyframes marquee { from { transform:translateX(0); } to { transform:translateX(-100%); } }

    .auth { display:flex; flex-direction:column; gap:10px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field input, .field select, .field textarea {
      background: rgba(255,255,255,.04); color: var(--text); border:1px solid rgba(255,255,255,.12);
      border-radius: 12px; padding: 10px 12px; outline: none; font: inherit; transition: border .2s;
    }
    .field input:focus, .field textarea:focus { border-color: var(--primary); }

    .tabs { display:flex; gap:8px; }
    .tab { flex:1; text-align:center; padding:10px 12px; border-radius:12px; cursor:pointer; user-select:none; border:1px solid rgba(255,255,255,.1); color: var(--muted); }
    .tab.active { color:white; border-color: transparent; background: rgba(79,140,255,.12); }

    /* Right: content views */
    .content { position:relative; overflow:hidden; }
    .view { position:absolute; inset:0; display:none; }
    .view.active { display:grid; grid-template-rows: 1fr auto; }

    /* Chat view */
    .chat-stream { overflow:auto; padding: 18px; display:flex; flex-direction:column; gap:12px; }
    .bubble { max-width: 72ch; padding: 10px 12px; border-radius: 14px; border:1px solid rgba(255,255,255,.08); background: #0e1731; }
    .bubble.me { background: #18224a; border-color: rgba(79,140,255,.4); }
    .bubble.admin { background: #0d2a1f; border-color: rgba(48,208,160,.5); }
    .meta { font-size:11px; color: var(--muted); margin-bottom: 4px; display:flex; gap:6px; align-items:center; }
    .msg { font-size:14px; white-space: pre-wrap; }
    .row { display:flex; gap:8px; padding: 12px; border-top: 1px solid rgba(255,255,255,.08); }
    .row input { flex:1; }

    /* Tickets view */
    .tickets { overflow:auto; padding: 18px; display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:14px; }
    .ticket { padding: 12px; border-radius: 14px; border:1px solid rgba(255,255,255,.08); background:#0f1838; display:flex; flex-direction:column; gap:8px; }
    .chip { display:inline-flex; align-items:center; gap:6px; background: var(--chip); color: #c9d5ff; border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:4px 10px; font-size:12px; }
    .status-Open { color:white; background: rgba(79,140,255,.2); }
    .status-In\ Progress { color:white; background: rgba(255,176,32,.22); }
    .status-Closed { color:white; background: rgba(44,192,113,.24); }

    .ticket-actions { display:flex; gap:8px; flex-wrap:wrap; }

    /* Admin view */
    .admin-panel { padding: 18px; display:flex; flex-direction:column; gap:12px; }
    .danger { background: linear-gradient(135deg, #ff5d5d, #ff9f6a); color:white; }
    .warn { background: linear-gradient(135deg, #ffb020, #ffd25b); color:#1a1300; }
    .okay { background: linear-gradient(135deg, #2cc071, #8ad6b1); color:#00170b; }

    /* Toast */
    .toast { position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(120%);
      background: rgba(20,28,56,.96); color: var(--text); border:1px solid rgba(255,255,255,.08);
      padding: 10px 14px; border-radius: 12px; transition: transform .25s ease; z-index: 50; }
    .toast.show { transform:translateX(-50%) translateY(0%); }

    /* Simple focus ring for a11y */
    :focus-visible { outline: 2px solid #5eb1f7; outline-offset: 2px; border-radius: 10px; }
  </style>
</head>
<body>
  <div class="shell">
    <header class="appbar">
      <div class="logo" aria-hidden="true">AO</div>
      <div>
        <div class="title">Welcome to <strong>Live Helpâ€‘Desk</strong> â€” Created by <strong>MR OZA</strong></div>
        <div class="subtitle">Welcome to AOIT & All Computer Science Class â€¢ Realâ€‘time help, history you can review, and ticket tracking.</div>
      </div>
      <div class="spacer"></div>
      <button id="btnSignOut" class="btn ghost" hidden><span class="icon">logout</span> Sign out</button>
    </header>

    <main class="main">
      <!-- LEFT PANEL -->
      <section class="card left">
        <div class="hero">
          <h1>Hi, <span id="who">Guest</span> ðŸ‘‹</h1>
          <div class="ticker"><span>Welcome to Live Helpâ€‘Desk â€¢ Welcome to AOIT & All Computer Science Class â€¢ Built with Firebase â€¢ Chat history is preserved â€¢ Be professional and respectful â€¢</span></div>
        </div>

        <div class="auth">
          <div class="field">
            <label for="displayName">Your display name</label>
            <input id="displayName" placeholder="e.g., Alex (AOIT)" autocomplete="name" />
          </div>

          <div class="field">
            <label for="rolePick">Role</label>
            <select id="rolePick">
              <option value="student">Student / Guest (anonymous)</option>
              <option value="admin">Admin (email login)</option>
            </select>
          </div>

          <div id="adminFields" class="field" hidden>
            <label for="adminEmail">Admin email</label>
            <input id="adminEmail" type="email" placeholder="admin@example.com" autocomplete="email" />
            <label for="adminPass" style="margin-top:6px">Admin password</label>
            <input id="adminPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
            <small style="color:var(--muted)">Tip: create an Admin user in Firebase Authentication â†’ Email/Password. Do <strong>not</strong> publish the password.</small>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btnSignIn" class="btn primary"><span class="icon">login</span> Sign in</button>
            <button id="btnUseSaved" class="btn" title="Use last name from this browser">Use saved name</button>
          </div>
        </div>

        <div class="tabs" style="margin-top:8px;">
          <div class="tab active" data-view="chatView"><span class="icon">forum</span>&nbsp;Chat</div>
          <div class="tab" data-view="ticketsView"><span class="icon">confirmation_number</span>&nbsp;Tickets</div>
          <div id="tabAdmin" class="tab" data-view="adminView" hidden><span class="icon">admin_panel_settings</span>&nbsp;Admin</div>
        </div>

        <div style="margin-top:8px; font-size:12px; color:var(--muted)">
          â€¢ Keep messages schoolâ€‘appropriate. â€¢ Do not share private information. â€¢ Tickets help track bigger issues.
        </div>
      </section>

      <!-- RIGHT PANEL: VIEWS -->
      <section class="card content">
        <!-- CHAT -->
        <div id="chatView" class="view active" role="region" aria-label="Chat">
          <div id="chatStream" class="chat-stream"></div>
          <div class="row">
            <input id="chatInput" maxlength="500" placeholder="Type your messageâ€¦"/>
            <button id="btnSend" class="btn primary"><span class="icon">send</span></button>
          </div>
        </div>

        <!-- TICKETS -->
        <div id="ticketsView" class="view" role="region" aria-label="Tickets">
          <div class="tickets" id="ticketList"></div>
          <div class="row" style="align-items:flex-start; flex-wrap:wrap; gap:8px;">
            <input id="tTitle" maxlength="80" placeholder="New ticket title" />
            <input id="tDesc" maxlength="200" placeholder="Short description" />
            <button id="btnAddTicket" class="btn okay"><span class="icon">add</span> Add Ticket</button>
          </div>
        </div>

        <!-- ADMIN -->
        <div id="adminView" class="view" role="region" aria-label="Admin">
          <div class="admin-panel">
            <div style="font-weight:700">Admin tools (visible only to MR Oza)</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button id="btnDeleteAllChat" class="btn danger"><span class="icon">delete_forever</span> Delete ALL chat</button>
              <button id="btnDeleteAllTickets" class="btn warn"><span class="icon">delete_sweep</span> Delete ALL tickets</button>
              <button id="btnExport" class="btn ghost"><span class="icon">download</span> Export data (JSON)</button>
            </div>
            <small style="color:var(--muted)">Note: These actions affect the database. Use carefully. Students cannot access these tools.</small>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Firebase (modular v11) via ESM CDN -->
  <script type="module">
    /* =======================
       Firebase bootstrapping
       ======================= */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAnalytics, isSupported as analyticsSupported } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js';
    import {
      getAuth, onAuthStateChanged, signInAnonymously,
      signInWithEmailAndPassword, signOut, updateProfile
    } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, orderBy,
      onSnapshot, doc, deleteDoc, updateDoc, getDocs, writeBatch, limit,
      where
    } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

    // Your Firebase configuration (provided by you)
    const firebaseConfig = {
      apiKey: "AIzaSyD4vP74YleiqqpVyIZzCQLqcjWIkcrzlxo",
      authDomain: "mr-oza-helpdesk.firebaseapp.com",
      projectId: "mr-oza-helpdesk",
      storageBucket: "mr-oza-helpdesk.firebasestorage.app", // not used (no Storage)
      messagingSenderId: "340032460471",
      appId: "1:340032460471:web:a0a87895948ca769199f32",
      measurementId: "G-PC18TN83WD"
    };

    const app = initializeApp(firebaseConfig);
    // Analytics is optional; only start if supported to avoid console warnings.
    try { if (await analyticsSupported()) getAnalytics(app); } catch (e) {}

    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* =======================
       Basic UI helpers
       ======================= */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const toastEl = $('#toast');
    const toast = (msg) => { toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 1600); };

    // Elements
    const whoEl = $('#who');
    const displayNameEl = $('#displayName');
    const rolePickEl = $('#rolePick');
    const adminFieldsEl = $('#adminFields');

    const btnSignIn = $('#btnSignIn');
    const btnUseSaved = $('#btnUseSaved');
    const btnSignOut = $('#btnSignOut');

    const chatView = $('#chatView');
    const ticketsView = $('#ticketsView');
    const adminView = $('#adminView');

    const tabAdmin = $('#tabAdmin');

    const chatStream = $('#chatStream');
    const chatInput = $('#chatInput');
    const btnSend = $('#btnSend');

    const tTitle = $('#tTitle');
    const tDesc = $('#tDesc');
    const ticketList = $('#ticketList');
    const btnAddTicket = $('#btnAddTicket');

    const btnDeleteAllChat = $('#btnDeleteAllChat');
    const btnDeleteAllTickets = $('#btnDeleteAllTickets');
    const btnExport = $('#btnExport');

    // Admin recognition (client-side fallback â€“ for convenience only).
    // For production, set a custom claim `admin:true` via Admin SDK.
    const ADMIN_EMAILS = [
      'koza12@unitedcharter.org', // <- add/change your admin emails here
    ];
    let isAdmin = false;
    let currentUser = null;

    // Persist and reuse display name
    const savedName = localStorage.getItem('helpdesk:name');
    if (savedName) displayNameEl.value = savedName;
    $('#btnUseSaved').addEventListener('click', () => {
      if (savedName) { displayNameEl.value = savedName; toast('Loaded your saved name.'); }
      else toast('No saved name yet.');
    });

    // Role picker toggles admin email/password fields
    rolePickEl.addEventListener('change', () => {
      adminFieldsEl.hidden = rolePickEl.value !== 'admin';
    });

    /* =======================
       Auth flows
       ======================= */
    btnSignIn.addEventListener('click', async () => {
      const role = rolePickEl.value;
      const name = (displayNameEl.value || '').trim().slice(0, 40) || 'Guest';
      localStorage.setItem('helpdesk:name', name);

      try {
        if (role === 'admin') {
          const email = $('#adminEmail').value.trim();
          const pass  = $('#adminPass').value;
          if (!email || !pass) return toast('Enter admin email and password.');
          await signInWithEmailAndPassword(auth, email, pass);
          // Name will be shown as the account displayName if present
        } else {
          // Anonymous student/guest sign-in
          await signInAnonymously(auth);
          // Set display name on the anonymous user for UI
          if (auth.currentUser) await updateProfile(auth.currentUser, { displayName: name });
        }
      } catch (e) {
        console.error(e); toast('Sign-in failed. Check details and try again.');
      }
    });

    btnSignOut.addEventListener('click', async () => {
      try { await signOut(auth); } catch (e) {}
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      const name = user?.displayName || savedName || 'Guest';
      whoEl.textContent = name || 'Guest';
      $('#btnSignOut').hidden = !user;

      // Lightweight admin detection (email match). Secure way uses custom claims.
      isAdmin = !!(user && user.email && ADMIN_EMAILS.includes(user.email));
      tabAdmin.hidden = !isAdmin;

      // Start/stop listeners based on auth
      if (user) {
        startChatListener();
        startTicketListener();
      } else {
        chatStream.innerHTML = '';
        ticketList.innerHTML = '';
      }
    });

    /* =======================
       Chat (Firestore: messages)
       ======================= */
    const messagesRef = collection(db, 'messages');
    let chatUnsub = null;

    function startChatListener(){
      if (chatUnsub) chatUnsub();
      const q = query(messagesRef, orderBy('createdAt', 'asc'), limit(300));
      chatUnsub = onSnapshot(q, (snap) => {
        chatStream.innerHTML = '';
        snap.forEach(docSnap => {
          const m = docSnap.data();
          const isMe = currentUser && m.uid === currentUser.uid;
          const bubble = document.createElement('div');
          bubble.className = 'bubble' + (isMe ? ' me' : '') + (m.role === 'admin' ? ' admin' : '');
          const meta = document.createElement('div'); meta.className = 'meta';
          const time = m.createdAt?.toDate ? m.createdAt.toDate() : new Date();
          meta.innerHTML = `<span class="icon">person</span>${escapeHtml(m.name||'Unknown')} Â· ${time.toLocaleString()}` +
                           (isAdmin ? ` Â· <button data-id="${docSnap.id}" class="btn ghost" style="padding:2px 6px; font-size:12px;">Delete</button>` : '');
          const msg = document.createElement('div'); msg.className = 'msg'; msg.textContent = m.text || '';
          bubble.appendChild(meta); bubble.appendChild(msg);
          chatStream.appendChild(bubble);
        });
        chatStream.scrollTop = chatStream.scrollHeight;
        // Wire up delete buttons (admin only)
        if (isAdmin) {
          chatStream.querySelectorAll('button[data-id]').forEach(btn => {
            btn.onclick = async () => {
              if (!confirm('Delete this message?')) return;
              await deleteDoc(doc(db, 'messages', btn.dataset.id));
            };
          });
        }
      });
    }

    btnSend.addEventListener('click', () => sendMessage());
    chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

    async function sendMessage(){
      const text = (chatInput.value || '').trim();
      if (!currentUser) return toast('Please sign in first.');
      if (!text) return; 
      try {
        await addDoc(messagesRef, {
          text: text.slice(0, 500),
          uid: currentUser.uid,
          name: currentUser.displayName || 'Guest',
          role: isAdmin ? 'admin' : 'student',
          createdAt: serverTimestamp()
        });
        chatInput.value = '';
      } catch (e) { console.error(e); toast('Could not send. Try again.'); }
    }

    /* =======================
       Tickets (Firestore: tickets)
       ======================= */
    const ticketsRef = collection(db, 'tickets');
    let ticketsUnsub = null;

    function startTicketListener(){
      if (ticketsUnsub) ticketsUnsub();
      const q = query(ticketsRef, orderBy('createdAt','desc'), limit(200));
      ticketsUnsub = onSnapshot(q, (snap) => {
        ticketList.innerHTML = '';
        snap.forEach(docSnap => renderTicket(docSnap.id, docSnap.data()));
      });
    }

    function renderTicket(id, t){
      const card = document.createElement('div'); card.className = 'ticket';
      const statusClass = 'status-' + (t.status||'Open').replace(' ','\\ ');
      card.innerHTML = `
        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
          <div class="chip ${statusClass}"><span class="icon">flag</span>${escapeHtml(t.status||'Open')}</div>
          <div style="font-size:12px; color:var(--muted);">${new Date((t.updatedAt?.toDate?.()||t.createdAt?.toDate?.()||new Date())).toLocaleString()}</div>
        </div>
        <div style="font-weight:700; font-size:15px;">${escapeHtml(t.title||'Untitled')}</div>
        <div style="color:var(--muted);">${escapeHtml(t.desc||'')}</div>
        <div style="font-size:12px; color:var(--muted);">By ${escapeHtml(t.creatorName||'Unknown')}</div>
        <div class="ticket-actions">
          <button class="btn ghost" data-act="prog"><span class="icon">play_arrow</span> In&nbsp;Progress</button>
          <button class="btn okay" data-act="close"><span class="icon">check_circle</span> Close</button>
          ${(isAdmin || (currentUser && currentUser.uid===t.creatorUid)) ? `<button class="btn danger" data-act="del"><span class="icon">delete</span> Delete</button>` : ''}
        </div>
      `;
      // Wire actions
      card.querySelectorAll('button').forEach(btn => {
        btn.onclick = async () => {
          if (btn.dataset.act === 'prog') await setTicketStatus(id, 'In Progress');
          if (btn.dataset.act === 'close') await setTicketStatus(id, 'Closed');
          if (btn.dataset.act === 'del') {
            if (!confirm('Delete this ticket?')) return;
            await deleteDoc(doc(db, 'tickets', id));
          }
        };
      });
      ticketList.appendChild(card);
    }

    async function setTicketStatus(id, status){
      const ref = doc(db, 'tickets', id);
      await updateDoc(ref, { status, updatedAt: serverTimestamp() });
      toast(`Ticket marked ${status}.`);
    }

    btnAddTicket.addEventListener('click', async () => {
      if (!currentUser) return toast('Please sign in first.');
      const title = (tTitle.value||'').trim();
      const desc  = (tDesc.value||'').trim();
      if (!title) return toast('Enter a title.');
      try {
        await addDoc(ticketsRef, {
          title: title.slice(0,80),
          desc:  desc.slice(0,200),
          status: 'Open',
          creatorUid: currentUser.uid,
          creatorName: currentUser.displayName || 'Guest',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        tTitle.value = ''; tDesc.value = '';
        toast('Ticket added.');
      } catch (e){ console.error(e); toast('Could not add ticket.'); }
    });

    /* =======================
       Admin bulk tools
       ======================= */
    btnDeleteAllChat.addEventListener('click', async () => {
      if (!isAdmin) return toast('Admin only.');
      if (!confirm('Delete ALL chat messages? This cannot be undone.')) return;
      await bulkDelete('messages');
      toast('All chat deleted.');
    });

    btnDeleteAllTickets.addEventListener('click', async () => {
      if (!isAdmin) return toast('Admin only.');
      if (!confirm('Delete ALL tickets? This cannot be undone.')) return;
      await bulkDelete('tickets');
      toast('All tickets deleted.');
    });

    btnExport.addEventListener('click', async () => {
      if (!isAdmin) return toast('Admin only.');
      const data = {};
      data.messages = await dumpCollection('messages');
      data.tickets  = await dumpCollection('tickets');
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `helpdesk-export-${new Date().toISOString().slice(0,19)}.json`;
      a.click();
    });

    async function dumpCollection(name){
      const out = [];
      const q = query(collection(db, name), limit(1000));
      const snap = await getDocs(q);
      snap.forEach(d => out.push({ id:d.id, ...d.data() }));
      return out;
    }

    async function bulkDelete(name){
      const ref = collection(db, name);
      let snap = await getDocs(query(ref, limit(500)));
      while (!snap.empty) {
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        snap = await getDocs(query(ref, limit(500)));
      }
    }

    /* =======================
       View switching
       ======================= */
    $$('.tab').forEach(tab => tab.addEventListener('click', () => {
      $$('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      $$('.view').forEach(v => v.classList.remove('active'));
      const v = document.getElementById(tab.dataset.view);
      if (v) v.classList.add('active');
    }));

    /* =======================
       Utilities
       ======================= */
    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }
  </script>

  <!--
  ======================================================
  ðŸ”’ Recommended Firestore security rules (paste in Rules)
  ======================================================
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isAdmin() { return request.auth.token.admin == true; }

      match /messages/{id} {
        allow read: if true; // anyone can read chat history
        allow create: if request.auth != null; // signed-in users can post
        allow update, delete: if isAdmin() || request.auth.uid == resource.data.uid;
      }

      match /tickets/{id} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update, delete: if isAdmin() || request.auth.uid == resource.data.creatorUid;
      }
    }
  }

  ðŸ‘‰ How to enable admin securely: use Firebase Admin SDK (server/Cloud Function) to set a custom claim on your admin user:
     admin.auth().setCustomUserClaims('<ADMIN_UID>', { admin: true })
  Then reâ€‘authenticate the admin account so request.auth.token.admin is present.

  Clientâ€‘side ADMIN_EMAILS is for convenience only (not secure). Do not rely on it for production.
  -->
</body>
</html>
